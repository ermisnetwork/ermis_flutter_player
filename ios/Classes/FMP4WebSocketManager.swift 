import Foundation

class FMP4WebSocketManager {
  private var task: URLSessionWebSocketTask?
  private let session: URLSession
  private weak var loader: FMP4ResourceLoader?

  init(loader: FMP4ResourceLoader) {
    self.loader = loader
    self.session = URLSession(configuration: .default)
  }

  func start(urlString: String) {
    guard let url = URL(string: urlString) else { return }
    task?.cancel(with: .goingAway, reason: nil)
    task = session.webSocketTask(with: url)
    task?.resume()
    receiveLoop()
  }

  private func receiveLoop() {
    task?.receive { [weak self] result in
      guard let self = self else { return }
      switch result {
        case .failure(let error):
          print("WebSocket error: \(error)")
        case .success(let message):
          switch message {
            case .data(let data):
              // server sends binary frames
              self.loader?.append(data: data)
            case .string(let text):
              // if server encodes binary as base64 string (rare), decode:
              if let d = Data(base64Encoded: text) {
                self.loader?.append(data: d)
              } else {
                // ignore or log
              }
            @unknown default:
              break
          }
      }
      // keep receiving
      self.receiveLoop()
    }
  }

  func stop() {
    task?.cancel(with: .goingAway, reason: nil)
    task = nil
  }
}